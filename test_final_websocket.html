<!DOCTYPE html>
<html>
<head>
    <title>Final WebSocket Test</title>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .success { color: #10B981; }
        .error { color: #EF4444; }
        .info { color: #3B82F6; }
        .warning { color: #F59E0B; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>WebSocket Connection Test - Final Debug</h1>
    
    <div id="status">‚è≥ Initializing...</div>
    <div id="transport"></div>
    <div id="messages"></div>
    
    <br>
    <button onclick="testConnection()">Test Connection</button>
    <button onclick="sendHealthCheck()">Send Health Check</button>
    <button onclick="testAudio()">Test Audio Data</button>
    
    <script>
        let socket = null;
        let messageCount = 0;
        
        function log(message, className = 'info') {
            const messagesDiv = document.getElementById('messages');
            const msgEl = document.createElement('div');
            msgEl.className = className;
            msgEl.textContent = `[${new Date().toISOString().split('T')[1].split('.')[0]}] ${message}`;
            messagesDiv.insertBefore(msgEl, messagesDiv.firstChild);
            messageCount++;
            if (messageCount > 50) {
                messagesDiv.removeChild(messagesDiv.lastChild);
            }
        }
        
        function updateStatus(text, className = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = text;
            statusEl.className = className;
        }
        
        function testConnection() {
            log('üîÑ Starting connection test...', 'info');
            
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            
            // Test with Socket.IO 4.x compatible settings
            socket = io('http://localhost:8000', {
                transports: ['polling', 'websocket'],
                upgrade: true,
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: 3,
                timeout: 10000,
                forceNew: true
            });
            
            // Socket.IO events
            socket.on('connect', () => {
                updateStatus(`‚úÖ Connected! Socket ID: ${socket.id}`, 'success');
                log(`Connected with transport: ${socket.io.engine.transport.name}`, 'success');
                document.getElementById('transport').textContent = `Transport: ${socket.io.engine.transport.name}`;
            });
            
            socket.on('disconnect', (reason) => {
                updateStatus('‚ùå Disconnected', 'error');
                log(`Disconnected: ${reason}`, 'error');
            });
            
            socket.on('connect_error', (error) => {
                updateStatus(`‚ùå Connection Error: ${error.message}`, 'error');
                log(`Connection error: ${error.message}`, 'error');
                log(`Error type: ${error.type}`, 'error');
                if (error.data) {
                    log(`Error data: ${JSON.stringify(error.data)}`, 'error');
                }
            });
            
            // Custom events from server
            socket.on('connected', (data) => {
                log(`Server says: ${JSON.stringify(data)}`, 'success');
            });
            
            socket.on('agent_response', (data) => {
                log(`Agent: ${data.text?.substring(0, 100)}...`, 'info');
                if (data.audio) {
                    log('Audio data received', 'success');
                }
            });
            
            socket.on('error', (error) => {
                log(`Server error: ${error.message || error}`, 'error');
            });
            
            socket.on('status_update', (data) => {
                log(`Status: ${data.status} - ${data.message}`, 'info');
            });
            
            socket.on('health_response', (data) => {
                log(`Health: ${JSON.stringify(data)}`, 'success');
            });
            
            // Engine.IO events for debugging
            socket.io.on('upgrade', (transport) => {
                log(`Upgraded to: ${transport.name}`, 'success');
                document.getElementById('transport').textContent = `Transport: ${transport.name}`;
            });
            
            socket.io.on('packet', (packet) => {
                log(`Packet type ${packet.type}: ${JSON.stringify(packet.data).substring(0, 100)}`, 'info');
            });
            
            socket.io.on('ping', () => {
                log('Ping sent', 'info');
            });
            
            socket.io.on('pong', (latency) => {
                log(`Pong received, latency: ${latency}ms`, 'info');
            });
        }
        
        function sendHealthCheck() {
            if (!socket || !socket.connected) {
                log('‚ùå Not connected', 'error');
                return;
            }
            socket.emit('health_check');
            log('Sent health_check event', 'info');
        }
        
        function testAudio() {
            if (!socket || !socket.connected) {
                log('‚ùå Not connected', 'error');
                return;
            }
            
            // Send test audio data
            const testAudioData = {
                audio: btoa('test audio data'),
                format: 'webm',
                timestamp: new Date().toISOString(),
                size: 1024
            };
            
            socket.emit('audio_data', testAudioData);
            log('Sent test audio data', 'info');
        }
        
        // Auto-connect on load
        window.onload = () => {
            log('Page loaded, starting auto-connection test...', 'info');
            testConnection();
        };
    </script>
</body>
</html>